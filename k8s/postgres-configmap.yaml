apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  labels:
    app: postgres
data:
  init.sql: |
    -- Les tables sont créées dans la base 'demo' (définie par POSTGRES_DB)
    
    -- Table des utilisateurs
    CREATE TABLE users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(100) UNIQUE NOT NULL,
        full_name VARCHAR(100),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Table des catégories de produits
    CREATE TABLE categories (
        id SERIAL PRIMARY KEY,
        name VARCHAR(50) NOT NULL,
        description TEXT
    );
    
    -- Table des produits
    CREATE TABLE products (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        description TEXT,
        price DECIMAL(10, 2) NOT NULL,
        stock INT DEFAULT 0,
        category_id INT REFERENCES categories(id),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Table des commandes
    CREATE TABLE orders (
        id SERIAL PRIMARY KEY,
        user_id INT REFERENCES users(id),
        total_amount DECIMAL(10, 2) NOT NULL,
        status VARCHAR(20) DEFAULT 'pending',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Table des items de commande
    CREATE TABLE order_items (
        id SERIAL PRIMARY KEY,
        order_id INT REFERENCES orders(id) ON DELETE CASCADE,
        product_id INT REFERENCES products(id),
        quantity INT NOT NULL,
        price DECIMAL(10, 2) NOT NULL
    );
    
    -- Insertion des données de démonstration
    
    -- Utilisateurs
    INSERT INTO users (username, email, full_name) VALUES
        ('alice', 'alice@example.com', 'Alice Dupont'),
        ('bob', 'bob@example.com', 'Bob Martin'),
        ('charlie', 'charlie@example.com', 'Charlie Bernard'),
        ('diana', 'diana@example.com', 'Diana Petit'),
        ('eve', 'eve@example.com', 'Eve Moreau');
    
    -- Catégories
    INSERT INTO categories (name, description) VALUES
        ('Électronique', 'Appareils électroniques et gadgets'),
        ('Livres', 'Romans, essais et livres techniques'),
        ('Vêtements', 'Vêtements et accessoires'),
        ('Maison', 'Articles pour la maison et décoration'),
        ('Sports', 'Équipements sportifs et fitness');
    
    -- Produits
    INSERT INTO products (name, description, price, stock, category_id) VALUES
        ('Laptop Pro 15', 'Ordinateur portable haute performance', 1299.99, 15, 1),
        ('Smartphone X', 'Smartphone dernière génération', 899.99, 30, 1),
        ('Écouteurs Sans Fil', 'Écouteurs bluetooth avec réduction de bruit', 199.99, 50, 1),
        ('Le Petit Prince', 'Roman classique d''Antoine de Saint-Exupéry', 12.99, 100, 2),
        ('Python pour les Nuls', 'Guide complet de programmation Python', 29.99, 45, 2),
        ('T-Shirt Coton Bio', 'T-shirt confortable en coton biologique', 24.99, 200, 3),
        ('Jean Slim', 'Jean coupe slim moderne', 59.99, 80, 3),
        ('Cafetière Italienne', 'Cafetière traditionnelle 6 tasses', 34.99, 25, 4),
        ('Lampe LED Design', 'Lampe de bureau design minimaliste', 49.99, 40, 4),
        ('Tapis de Yoga', 'Tapis de yoga antidérapant', 39.99, 60, 5),
        ('Haltères 5kg', 'Paire d''haltères 5kg', 29.99, 35, 5);
    
    -- Commandes
    INSERT INTO orders (user_id, total_amount, status) VALUES
        (1, 1499.98, 'delivered'),
        (2, 224.98, 'shipped'),
        (3, 89.97, 'pending'),
        (1, 1329.98, 'delivered'),
        (4, 62.98, 'processing');
    
    -- Items de commande
    INSERT INTO order_items (order_id, product_id, quantity, price) VALUES
        -- Commande 1 (Alice)
        (1, 1, 1, 1299.99),
        (1, 3, 1, 199.99),
        -- Commande 2 (Bob)
        (2, 6, 3, 24.99),
        (2, 4, 10, 12.99),
        -- Commande 3 (Charlie)
        (3, 10, 2, 39.99),
        (3, 5, 1, 29.99),
        -- Commande 4 (Alice)
        (4, 2, 1, 899.99),
        (4, 7, 1, 59.99),
        (4, 8, 1, 34.99),
        (4, 9, 1, 49.99),
        -- Commande 5 (Diana)
        (5, 11, 2, 29.99),
        (5, 4, 1, 12.99);
    
    -- Créer des vues utiles pour les requêtes
    CREATE VIEW order_details AS
    SELECT 
        o.id AS order_id,
        u.username,
        u.email,
        o.total_amount,
        o.status,
        o.created_at AS order_date,
        COUNT(oi.id) AS items_count
    FROM orders o
    JOIN users u ON o.user_id = u.id
    LEFT JOIN order_items oi ON o.id = oi.order_id
    GROUP BY o.id, u.username, u.email, o.total_amount, o.status, o.created_at;
    
    CREATE VIEW product_inventory AS
    SELECT 
        p.id,
        p.name,
        p.price,
        p.stock,
        c.name AS category,
        COALESCE(SUM(oi.quantity), 0) AS total_sold
    FROM products p
    JOIN categories c ON p.category_id = c.id
    LEFT JOIN order_items oi ON p.id = oi.product_id
    GROUP BY p.id, p.name, p.price, p.stock, c.name;
    
    -- Afficher un résumé
    SELECT 'Base de données initialisée avec succès!' AS message;
    SELECT COUNT(*) AS total_users FROM users;
    SELECT COUNT(*) AS total_products FROM products;
    SELECT COUNT(*) AS total_orders FROM orders;
